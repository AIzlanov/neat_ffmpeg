name: Build and Release Neat FFmpeg

on:
  push:
    tags:
      - 'v*' # Срабатывает при пуше тега, например v1.3.0

permissions:
  contents: write  # Это дает право создавать релизы и загружать файлы

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        # Установка зависимостей из вашего requirements.txt
        if (Test-Path "requirements.txt") { pip install -r requirements.txt }

    - name: Build EXE with PyInstaller
      run: |
        # Собираем в один файл, без консоли. 
        # Если у вас появится файл icon.ico, добавьте в строку ниже: --icon="icon.ico"
        pyinstaller --noconfirm --onefile --windowed --add-data "ui;ui" --add-data "utils.py;." --add-data "workers.py;." --name "neat_ffmpeg" main.py

    - name: Prepare Assets (Download FFmpeg and Deno)
      shell: pwsh
      run: |
        # 1. Создаем структуру
        New-Item -ItemType Directory -Force -Path "dist/ffmpeg/bin"
        
        # 2. Скачиваем FFmpeg (Essentials build - он легче)
        $ffmpegUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
        Invoke-WebRequest -Uri $ffmpegUrl -OutFile "ffmpeg.zip"
        
        # 3. Распаковываем только bin (ffmpeg.exe и ffprobe.exe)
        Expand-Archive -Path "ffmpeg.zip" -DestinationPath "temp_ffmpeg" -Force
        $binFolder = Get-ChildItem -Path "temp_ffmpeg" -Filter "bin" -Recurse | Select-Object -First 1
        Copy-Item -Path "$($binFolder.FullName)\*" -Destination "dist/ffmpeg/bin" -Force
        
        # 4. Скачиваем Deno
        $denoUrl = "https://github.com/denoland/deno/releases/latest/download/deno-x86_64-pc-windows-msvc.zip"
        Invoke-WebRequest -Uri $denoUrl -OutFile "deno.zip"
        Expand-Archive -Path "deno.zip" -DestinationPath "dist/ffmpeg/bin" -Force
        
        # 5. Чистка временных архивов
        Remove-Item "ffmpeg.zip", "deno.zip"
        Remove-Item -Recurse -Force "temp_ffmpeg"

    - name: Create 7z Archive
      shell: pwsh
      run: |
        # Упаковываем содержимое dist в архив 7z (уровень сжатия 9 - ультра)
        cd dist
        7z a -t7z -mx=9 ../neat_ffmpeg_v1.3.0.7z *

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: neat_ffmpeg_v1.3.0.7z
        # Тело релиза будет взято из вашего последнего тега или можно добавить описание тут
        body: "Автоматическая сборка версии 1.3.0. Включает в себя neat_ffmpeg.exe, FFmpeg и Deno."
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}